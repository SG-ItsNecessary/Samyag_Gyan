const articles = [
  {
    "title": "Digital Public Infrastructure in India",
    "article_type": "news", // ➡️ NEW: Article category (news, editorial, ethics, essay)
    "hashtags": "#Governance #DigitalIndia #CurrentAffairs", //
    "source_ribbon": "the-hindu", // ➡️ Renamed property
    "secondary_ribbon": "Essay + GS2", // ➡️ Renamed property
    "publish_date": "18 July 2025", // ➡️ Renamed property
    "prelude_title": "Why should I read it?", // ➡️ Split into two properties
    "prelude_body": "It ties digital India with delivery on the ground. You'll see governance come alive in numbers. Also, it's a gem for GS2 introductions.", // ➡️ Split into two properties
    "content": [
      {
        "main_question_id": 101, // Example ID for the database
        "main_answer_id": 201, // Example ID for the database
        "article_id": 1,
        "language": "en",
        "question": "✦ What is Digital Public Infrastructure (DPI)?",
        "answer": "DPI refers to foundational systems like Aadhaar, UPI, DigiLocker and more that create a base for scalable public digital services. These systems enable identity, payments, and document verification at scale. Together, they make service delivery faster, cheaper, and more inclusive. This public-facing technology stack is built on open standards, promoting a shared ecosystem for innovation. It operates on a consent-based framework, giving citizens control over their data while ensuring security and privacy. The integrated nature of these platforms is what allows for a seamless and interconnected digital economy."
      },
      {
        "main_question_id": 102,
        "main_answer_id": 202,
        "article_id": 1,
        "language": "en",
        "question": "✦ How is DPI transforming governance?",
        "answer": "Government schemes use Aadhaar-based DBT to directly transfer benefits, avoiding middlemen and leakages. DigiLocker digitizes records like driving licenses and academic certificates. UPI allows anyone with a phone and bank account to send or receive payments instantly, without transaction fees. This direct transfer model has revolutionized welfare distribution, ensuring that subsidies reach the intended beneficiaries efficiently. The digitization of documents reduces bureaucratic hurdles and makes government services more accessible to a wider population. The widespread adoption of UPI has also bolstered financial inclusion, bringing millions into the formal banking system for the first time."
      },
      {
        "main_question_id": 103,
        "main_answer_id": 203,
        "article_id": 1,
        "language": "en",
        "question": "✦ Why is India's model globally praised?",
        "answer": "India's DPI stack is open, low-cost, scalable, and sovereign. It's being adapted by countries in Africa, Latin America, and Southeast Asia. The absence of corporate dependencies (like GAFA) makes it attractive for nations seeking self-reliance in digital governance. This approach provides a viable alternative to proprietary, corporate-driven models, which often come with high costs and data control issues. The open-source nature of the technology encourages global collaboration and co-creation. Ultimately, India's model demonstrates that a public-good approach can be a powerful engine for both economic growth and social equity."
      }
    ],
    "endRibbons": [
      {
        "label": " Mindmap (English)",
        "color": "#FF9800",
        "type": "mindmap",
        "src": "1.jpeg"
      },
      {
        "label": " Prelims Pointers",
        "color": "#673AB7",
        "type": "prelims",
        "content": [
          {
            "prelims_question_id": 301, // Example ID for the database
            "prelims_answer_id": 401, // Example ID for the database
            "article_id": 1,
            "language": "en",
            "q": "What is DPI?",
            "a": "DPI is the foundational digital infrastructure for public services like Aadhaar and UPI, providing a secure and interoperable platform for identity, payments, and data exchange. It enables efficient and inclusive service delivery across various sectors, creating a robust digital ecosystem that benefits all citizens."
          },
          {
            "prelims_question_id": 302,
            "prelims_answer_id": 402,
            "article_id": 1,
            "language": "en",
            "q": "Why important?",
            "a": "DPI is crucial for ensuring financial and social inclusion, as it provides a low-cost, scalable, and transparent way to deliver benefits and services directly to citizens. By reducing leakages and streamlining processes, it enhances governance, fosters economic growth, and helps India achieve its Sustainable Development Goals."
          }
        ]
      },
      {
        "label": " माइंडमैप (Hindi)",
        "color": "#FF9800",
        "type": "mindmap",
        "src": "mindmap_hin1.jpg"
      }
    ]
  },
  {
    "title": "India's Renewable Energy Transition",
    "article_type": "editorial", // ➡️ NEW: Editorial article type
    "hashtags": "#Environment #Energy #GS3",
    "source_ribbon": "indian-express",
    "secondary_ribbon": "GS3 Case Study + SDG Linkage",
    "publish_date": "18 July 2025",
    "prelude_title": "Why should I read it?",
    "prelude_body": "This ties India's green push to global promises. Makes SDGs, solar parks and hydrogen efforts easy to cite. Every sentence can become a pointer in notes.",
    "content": [
      {
        "main_question_id": 104,
        "main_answer_id": 204,
        "article_id": 2,
        "language": "en",
        "question": "✦ Why renewable energy for India?",
        "answer": "India has rising energy needs, a large rural population, and global climate commitments. Renewable sources like solar and wind offer sustainable, decentralized alternatives to coal-based energy. Clean energy reduces pollution and dependency on imported oil. Shifting to renewables also enhances the country's energy security, protecting it from volatile international fuel markets. The transition supports sustainable development goals and creates new job opportunities in the green sector. Moreover, decentralized renewable energy solutions are ideal for electrifying remote rural areas that are difficult to connect to the traditional grid."
      },
      {
        "main_question_id": 105,
        "main_answer_id": 205,
        "article_id": 2,
        "language": "en",
        "question": "✦ What major steps has India taken?",
        "answer": "The National Solar Mission has scaled solar parks across states. New incentives encourage green hydrogen and battery storage. India aims to install 500 GW of non-fossil capacity by 2030, supporting SDG 7 (Affordable & Clean Energy). The government has implemented a Production Linked Incentive (PLI) scheme to boost domestic manufacturing of solar PV modules and advanced chemistry cells. Programs like PM-KUSUM help farmers adopt solar pumps, which reduces reliance on fossil fuels for irrigation. The country is also focusing on developing a robust green energy corridor to transmit renewable power from generation sites to consumption centers efficiently."
      },
      {
        "main_question_id": 106,
        "main_answer_id": 206,
        "article_id": 2,
        "language": "en",
        "question": "✦ What challenges remain?",
        "answer": "Energy storage tech is still evolving. Land acquisition delays big projects. Transmission infrastructure needs investment. The intermittent nature of solar and wind power requires sophisticated grid management and large-scale battery storage solutions. Social challenges include the potential for job displacement in the traditional coal industry and the need for reskilling the workforce. Securing financing for large-scale renewable projects, especially in the early stages, also presents a significant hurdle for developers and investors."
      }
    ],
    "endRibbons": [
      {
        "label": " Mindmap (English)",
        "color": "#FF9800",
        "type": "mindmap",
        "src": "mindmap_eng2.jpg"
      },
      {
        "label": " Prelims Pointers",
        "color": "#673AB7",
        "type": "prelims",
        "content": [
          {
            "prelims_question_id": 303,
            "prelims_answer_id": 403,
            "article_id": 2,
            "language": "en",
            "q": "Target by 2030?",
            "a": "India has set a highly ambitious target of achieving 500 GW of non-fossil fuel electricity generation capacity by 2030, which is a key component of its commitment to combating climate change. This goal is crucial for meeting the country's growing energy needs in a sustainable manner and reducing its reliance on fossil fuels."
          },
          {
            "prelims_question_id": 304,
            "prelims_answer_id": 404,
            "article_id": 2,
            "language": "en",
            "q": "New initiatives?",
            "a": "Recent initiatives include a strong policy push for green hydrogen, which is seen as a key fuel for the future, and new incentives for battery storage projects to address the intermittency of renewable sources. The government is also promoting the establishment of large-scale solar parks to achieve economies of scale and accelerate the deployment of solar energy across the country."
          }
        ]
      },
      {
        "label": " माइंडमैप (हिन्दी)",
        "color": "#FF9800",
        "type": "mindmap",
        "src": "mindmap_hin2.jpg"
      }
    ]
  }
];

const sourceMap = { "the-hindu": "The Hindu", "indian-express": "Indian Express", "both": "Both (IE + TH)", "pib-other": "PIB / Other" };

const source_ribbon = { "the-hindu": "#009688", "indian-express": "#8BC34A", "both": "#2196F3", "pib-other": "#D32F2F" };

function renderArticles() { 
  const container = document.getElementById('articles-container'); 
  container.innerHTML = '';

  articles.forEach((article) => {
    const tile = document.createElement('div');
    tile.classList.add('article-tile');
    tile.classList.add('article-panel'); // For button logic selector
    tile.dataset.expanded = 'false';
    tile.dataset.articleId = article.article_id || article.title; // For interaction logging
    tile.dataset.userId = 'current-user'; // Will be replaced by actual userId from auth

    const leftRibbon = document.createElement('div');
    leftRibbon.className = 'source-ribbon';
    leftRibbon.textContent = sourceMap[article.source_ribbon] || "Source"; //  Correct property name
    leftRibbon.style.backgroundColor = source_ribbon[article.source_ribbon] || "#666"; //  Correct property name

    const usabilityRibbon = document.createElement('div');
    usabilityRibbon.className = 'usability-ribbon';
    usabilityRibbon.textContent = article.secondary_ribbon || ""; // Correct property name

    const title = document.createElement('div');
    title.className = 'article-title';
    title.textContent = article.title;

    const tags = document.createElement('div');
    tags.className = 'tags';
    tags.textContent = article.hashtags; //  Correct property name

    const dateBlock = document.createElement('div');
    dateBlock.className = 'article-date';
    dateBlock.textContent = article.publish_date || ""; //  Correct property name
    dateBlock.style.display = 'none';

    const preludeWrap = document.createElement('div');
    preludeWrap.className = 'prelude-section';
    preludeWrap.innerHTML = `
      <span class="prelude-title">${article.prelude_title || 'Why should I read it?'}</span>
      <span class="prelude-body">${article.prelude_body || ''}</span>
    `; // ✅ Correct property names
    preludeWrap.style.display = 'none';

    const contentArea = document.createElement('div');
    contentArea.className = 'content-area highlight-zone';
    contentArea.style.display = 'none';

    // ==================== MAIN CONTENT Q&A ====================
    article.content.forEach((qna) => {
      const q = document.createElement('span');
      q.className = 'question';
      q.dataset.main_question_id = qna.main_question_id;
      q.dataset.article_id = qna.article_id;
      q.dataset.language = qna.language || 'en';
      q.textContent = qna.question;

      const a = document.createElement('p');
      a.className = 'answer';
      a.dataset.main_answer_id = qna.main_answer_id;
      a.dataset.main_question_id = qna.main_question_id;
      a.dataset.article_id = qna.article_id;
      a.dataset.language = qna.language || 'en';
      a.textContent = qna.answer;

      contentArea.appendChild(q);
      contentArea.appendChild(a);
    });

    const endRibbonZone = document.createElement('div');
    endRibbonZone.className = 'end-content-ribbons';
    endRibbonZone.style.display = 'none';

    const subContentBox = document.createElement('div');
    subContentBox.className = 'sub-tile';
    subContentBox.style.display = 'none';

    article.endRibbons.forEach((r) => {
      const ribbon = document.createElement('div');
      ribbon.className = 'end-content-ribbon-item';
      ribbon.textContent = r.label;
      ribbon.style.backgroundColor = r.color;

      ribbon.addEventListener('click', () => {
        subContentBox.innerHTML = '';
        if (r.type === 'mindmap') {
          openFloatingViewer(r.src);
        } else if (r.type === 'prelims') {
          const wrapper = document.createElement('div');
          wrapper.className = 'prelims-content-wrapper';
          r.content.forEach((qna) => {
            const q = document.createElement('div');
            q.className = 'prelims-question';
            q.dataset.prelims_question_id = qna.prelims_question_id;
            q.dataset.article_id = qna.article_id;
            q.dataset.language = qna.language || 'en';
            q.textContent = qna.q;

            const a = document.createElement('div');
            a.className = 'prelims-answer';
            a.dataset.prelims_answer_id = qna.prelims_answer_id;
            a.dataset.prelims_question_id = qna.prelims_question_id;
            a.dataset.article_id = qna.article_id;
            a.dataset.language = qna.language || 'en';
            a.textContent = qna.a;

            wrapper.appendChild(q);
            wrapper.appendChild(a);
          });
          subContentBox.appendChild(wrapper);
          subContentBox.style.display = 'block';
        }
      });
      endRibbonZone.appendChild(ribbon);
    });

    const arrowContainer = document.createElement('div');
    const arrowBtn = document.createElement('button');
    arrowBtn.className = 'main-arrow-btn';
    arrowBtn.innerHTML = '<div class="css-arrow"></div>';

    arrowBtn.addEventListener('click', () => {
      const isExpanded = tile.classList.contains('expanded');
      document.querySelectorAll('.article-tile').forEach((t) => {
        t.classList.remove('expanded');
        t.dataset.expanded = 'false';
        t.querySelector('.content-area').style.display = 'none';
        t.querySelector('.sub-tile').style.display = 'none';
        t.querySelector('.end-content-ribbons').style.display = 'none';
        t.querySelector('.prelude-section').style.display = 'none';
        t.querySelector('.article-date').style.display = 'none';
        t.querySelector('.main-arrow-btn').classList.remove('rotated');
        if (t.querySelector('.read-button-wrapper')) {
          t.querySelector('.read-button-wrapper').style.display = 'none';
        }
        // Hide button row when collapsing
        if (t.querySelector('.button-row')) {
          t.querySelector('.button-row').style.display = 'none';
        }
        // Hide archive button when collapsing
        if (t.querySelector('.archive-btn-left')) {
          t.querySelector('.archive-btn-left').style.display = 'none';
        }
        // Close any open summary modals when collapsing
        const summaryModal = document.getElementById('summaryModal');
        if (summaryModal) {
          summaryModal.classList.remove('visible');
        }
      });

      if (!isExpanded) {
        tile.classList.add('expanded');
        tile.dataset.expanded = 'true';
        contentArea.style.display = 'block';
        endRibbonZone.style.display = 'flex';
        preludeWrap.style.display = 'block';
        dateBlock.style.display = 'block';
        arrowBtn.classList.add('rotated');
        updateURLForArticle(article.title, article.publish_date, article.article_type || 'news'); // ✅ Pass article type
        readButtonWrapper.style.display = 'flex';
        showTileTooltip();
        // Show button row when expanding
        buttonRow.style.display = 'flex';
        // Show archive button when expanding (if exists)
        if (tile.querySelector('.archive-btn-left')) {
          tile.querySelector('.archive-btn-left').style.display = 'block';
        }
      }
    });

    arrowContainer.className = 'arrow-container';
    arrowContainer.appendChild(arrowBtn);

    tile.appendChild(leftRibbon);
    tile.appendChild(usabilityRibbon);
    tile.appendChild(title);
    tile.appendChild(tags);
    tile.appendChild(dateBlock);
    tile.appendChild(preludeWrap);
    tile.appendChild(contentArea);
    tile.appendChild(endRibbonZone);
    tile.appendChild(subContentBox);

    const readButtonWrapper = document.createElement('div');
    readButtonWrapper.className = 'read-button-wrapper';
    readButtonWrapper.innerHTML = ``;
    readButtonWrapper.style.display = 'none';
    tile.appendChild(readButtonWrapper);

    const separator = document.createElement('hr');
    separator.className = 'tile-separator';
    tile.appendChild(separator);

    // ==================== BUTTON ROW INTEGRATION ====================
    const buttonRow = document.createElement('div');
    buttonRow.className = 'button-row';
    buttonRow.style.display = 'none'; // Hidden by default
    buttonRow.dataset.articleId = article.article_id || article.title; // Use article_id or title as unique identifier

    // Determine if this article is voteable (first article is editorial - not voteable)
    const isFirstArticle = articles.indexOf(article) === 0;
    const voteableAttr = isFirstArticle ? 'data-is-voteable="false"' : '';

    buttonRow.innerHTML = `
      <!-- Mark as Read Button -->
      <div class="button-wrapper">
        <div class="mark-read-wrapper">
          <button class="read-button" id="markReadBtn-${article.article_id || article.title}" title="Mark this article as read to unlock other actions">
            <svg class="read-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <path d="M18 6V4a2 2 0 1 0-4 0v2"/>
              <path d="M20 15v6a1 1 0 0 1-1 1H6.5a1 1 0 0 1 0-5H20"/>
              <path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H10"/>
              <rect x="12" y="6" width="8" height="5" rx="1"/>
            </svg>
            <span class="read-text"> Read ??</span>
          </button>
          <span class="ticks" id="readTicks-${article.article_id || article.title}"></span>
        </div>
        <!-- Info Icon Component -->
        <div class="info-container" data-target="read-info">
          <div class="info-icon">i</div>
          <div class="tooltip">
            Click "Mark as Read" to unlock all interactive features for this article (voting, bookmarking, and summary notes).
          </div>
        </div>
      </div>

      <!-- Vote Button -->
      <div class="button-wrapper">
        <button class="action-btn" id="voteBtn-${article.article_id || article.title}" data-action="vote" ${voteableAttr} title="Vote for this article to be featured in the next magazine">
          <svg viewBox="0 0 490.667 490.667" xml:space="preserve">
            <path class="icon-path" d="M245.333,0C110.059,0,0,110.059,0,245.333s110.059,245.333,245.333,245.333s245.333-110.059,245.333-245.333 S380.608,0,245.333,0z M103.893,131.989C138.56,88.789,190.123,64,245.333,64s106.752,24.789,141.44,67.989 c3.691,4.587,2.944,11.307-1.643,14.997c-1.963,1.579-4.331,2.347-6.677,2.347c-3.115,0-6.229-1.365-8.341-3.989 c-30.613-38.144-76.075-60.011-124.8-60.011s-94.187,21.867-124.8,60.011c-3.691,4.608-10.389,5.333-14.997,1.643 C100.949,143.296,100.203,136.576,103.893,131.989z M256,213.333c-5.888,0-10.667-4.779-10.667-10.667S250.112,192,256,192h64 c5.888,0,10.667,4.779,10.667,10.667s-4.779,10.667-10.667,10.667h-21.333V288c0,5.888-4.779,10.667-10.667,10.667 s-10.667-4.779-10.667-10.667v-74.667H256z M234.667,224v42.667c0,17.643-14.357,32-32,32c-17.643,0-32-14.357-32-32V224 c0-17.643,14.357-32,32-32C220.309,192,234.667,206.357,234.667,224z M96.683,291.755l-32-85.333 c-2.069-5.525,0.725-11.669,6.229-13.739c5.525-2.027,11.669,0.725,13.739,6.229l22.016,58.709l22.016-58.709 c2.069-5.525,8.192-8.277,13.739-6.229c5.504,2.069,8.299,8.213,6.229,13.739l-32,85.333c-1.557,4.16-5.547,6.912-9.984,6.912 C102.229,298.667,98.24,295.915,96.683,291.755z M376.789,370.005c-34.667,36.523-81.344,56.661-131.456,56.661 s-96.811-20.117-131.456-56.661c-4.053-4.288-3.883-11.029,0.405-15.083c4.288-4.032,11.051-3.861,15.083,0.405 c30.592,32.256,71.787,50.005,115.989,50.005c44.203,0,85.397-17.771,115.989-50.005c4.053-4.267,10.816-4.437,15.083-0.405 C380.693,358.955,380.843,365.739,376.789,370.005z M373.333,234.667c5.888,0,10.667,4.779,10.667,10.667 S379.221,256,373.333,256h-10.667v21.333h32c5.888,0,10.667,4.779,10.667,10.667s-4.779,10.667-10.667,10.667H352 c-5.888,0-10.667-4.779-10.667-10.667v-85.333c0-5.888,4.779-10.667,10.667-10.667h42.667c5.888,0,10.667,4.779,10.667,10.667 s-4.779,10.667-10.667,10.667h-32v21.333H373.333z"/>
            <path class="icon-path" d="M192,224v42.667c0,5.888,4.779,10.667,10.667,10.667s10.667-4.779,10.667-10.667V224c0-5.888-4.779-10.667-10.667-10.667 S192,218.112,192,224z"/>
          </svg>
          <span> Vote ?</span>
        </button>
        <!-- Info Icon Component (changes based on voteable status) -->
        <div class="info-container" data-target="${isFirstArticle ? 'vote-editorial-disabled-info' : 'vote-info'}">
          <div class="info-icon">i</div>
          <div class="tooltip">
            ${isFirstArticle
              ? 'This is an Editorial article - always included in SG Magazine. Only news/current affairs can be community-voted.'
              : 'Your vote decides what goes into the SG Magazine! Top 5 voted articles each fortnight will be condensed and included.'}
          </div>
        </div>
      </div>

      <!-- Summary Button -->
      <div class="button-wrapper">
        <button class="action-btn" id="summaryBtn-${article.article_id || article.title}" data-action="summary" title="Write your own summary notes for this article">
          <svg viewBox="0 0 24 24">
            <path class="icon-path" d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
            <path class="icon-path" d="M14 2v6h6M8 15h8M8 11h8M8 19h8"/>
          </svg>
          <span>Summary</span>
        </button>
        <!-- Info Icon Component -->
        <div class="info-container" data-target="summary-info">
          <div class="info-icon">i</div>
          <div class="tooltip">
            Use this button as your notepad. Jot down notes in any way you like for revision.
          </div>
        </div>
      </div>

      <!-- Bookmark Button -->
      <div class="button-wrapper">
        <button class="action-btn" id="bookmarkBtn-${article.article_id || article.title}" data-action="bookmark" title="Bookmark this article for Mains revision">
          <svg viewBox="0 0 24 24">
            <path class="icon-path" d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path>
          </svg>
          <span id="bookmarkText-${article.article_id || article.title}">Bookmark</span>
        </button>
        <!-- Info Icon Component -->
        <div class="info-container" data-target="bookmark-info">
          <div class="info-icon">i</div>
          <div class="tooltip">
            Save this article for later revision. Access your bookmarked articles from "Your Journal" in the navigation menu.
          </div>
        </div>
      </div>

      <div class="share-btn-wrapper">
        <button class="share-btn" id="shareBtn-${article.article_id || article.title}" data-action="share" title="Share this article on Telegram with your peers">
          <svg class="telegram-icon" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
            viewBox="0 0 512 512" xml:space="preserve">
            <circle style="fill:#47B0D3;" cx="256" cy="256" r="256"/>
            <path style="fill:#3298BA;" d="M34.133,256c0-135.648,105.508-246.636,238.933-255.421C267.424,0.208,261.737,0,256,0
              C114.615,0,0,114.615,0,256s114.615,256,256,256c5.737,0,11.424-0.208,17.067-0.579C139.642,502.636,34.133,391.648,34.133,256z"/>
            <path style="fill:#E5E5E5;" d="M380.263,109.054c-2.486-1.69-5.676-1.946-8.399-0.679L96.777,236.433
              c-4.833,2.251-7.887,7.172-7.766,12.501c0.117,5.226,3.28,9.92,8.065,12.015l253.613,110.457c8.468,3.849,18.439-2.21,18.983-11.453
              l14.314-243.341C384.161,113.614,382.748,110.742,380.263,109.054z"/>
            <polygon style="fill:#CCCCCC;" points="171.631,293.421 188.772,408 379.168,108.432 "/>
            <path style="fill:#FFFFFF;" d="M371.866,108.375L96.777,236.433c-4.737,2.205-7.826,7.121-7.769,12.345
              c0.058,5.233,3.276,10.074,8.067,12.171l74.557,32.471l207.536-184.988C376.882,107.33,374.203,107.287,371.866,108.375z"/>
            <polygon style="fill:#E5E5E5;" points="211.418,310.749 188.772,408 379.168,108.432 "/>
            <path style="fill:#FFFFFF;" d="M380.263,109.054c-0.351-0.239-0.72-0.442-1.095-0.622l-167.75,202.317l139.27,60.657
              c8.468,3.849,18.439-2.21,18.983-11.453l14.314-243.341C384.161,113.614,382.748,110.742,380.263,109.054z"/>
          </svg>
          <span class="share-text">Share</span>
        </button>
      </div>
    `;

    tile.appendChild(buttonRow);

    // ==================== DYNAMIC ARCHIVE BUTTON + ARROW ROW ====================
    // Create wrapper that holds archive button (left) and arrow (right)
    const topControlsRow = document.createElement('div');
    topControlsRow.className = 'top-controls-row';
    topControlsRow.style.cssText = `
      display: flex;
      justify-content: space-between;
      align-items: center;
      width: 100%;
    `;

    // Add archive button based on article type (left side)
    const articleType = article.article_type || 'news';
    const archiveBtnLeft = document.createElement('div');
    archiveBtnLeft.className = 'archive-btn-left';
    archiveBtnLeft.style.display = 'none'; // Hidden by default, shown when expanded

    if (articleType === 'editorial') {
      archiveBtnLeft.innerHTML = `
        <a href="/upsc-editorials/"
           target="_blank"
           rel="noopener noreferrer"
           class="chip-btn"
           style="
             background-color: #fc7306;
             color: #ffffff;
             border: 2px solid #fcd7b6;
             border-radius: 9999px;
             padding: 5px 14px;
             font-size: 9px;
             font-weight: 700;
             cursor: pointer;
             text-decoration: none;
             display: inline-block;
             box-shadow: 0 2px 6px rgba(0,0,0,0.08);
             transition: all 0.25s ease;
           "
           onmouseover="this.style.backgroundColor='#ff8b33'; this.style.boxShadow='0 4px 10px rgba(0,0,0,0.15)';"
           onmouseout="this.style.backgroundColor='#fc7306'; this.style.boxShadow='0 2px 6px rgba(0,0,0,0.08)';"
           onmousedown="this.style.backgroundColor='#e45e00';"
           onmouseup="this.style.backgroundColor='#ff8b33';">
          All Editorials on SG
        </a>
      `;
    } else if (articleType === 'ethics') {
      archiveBtnLeft.innerHTML = `
        <a href="/upsc-ethics/"
           target="_blank"
           rel="noopener noreferrer"
           class="chip-btn"
           style="
             background-color: #fc7306;
             color: #ffffff;
             border: 2px solid #fcd7b6;
             border-radius: 9999px;
             padding: 5px 14px;
             font-size: 9px;
             font-weight: 700;
             cursor: pointer;
             text-decoration: none;
             display: inline-block;
             box-shadow: 0 2px 6px rgba(0,0,0,0.08);
             transition: all 0.25s ease;
           "
           onmouseover="this.style.backgroundColor='#ff8b33'; this.style.boxShadow='0 4px 10px rgba(0,0,0,0.15)';"
           onmouseout="this.style.backgroundColor='#fc7306'; this.style.boxShadow='0 2px 6px rgba(0,0,0,0.08)';"
           onmousedown="this.style.backgroundColor='#e45e00';"
           onmouseup="this.style.backgroundColor='#ff8b33';">
          All Ethics on SG
        </a>
      `;
    } else if (articleType === 'essay') {
      archiveBtnLeft.innerHTML = `
        <a href="/upsc-essays/"
           target="_blank"
           rel="noopener noreferrer"
           class="chip-btn"
           style="
             background-color: #fc7306;
             color: #ffffff;
             border: 2px solid #fcd7b6;
             border-radius: 9999px;
             padding: 5px 14px;
             font-size: 9px;
             font-weight: 700;
             cursor: pointer;
             text-decoration: none;
             display: inline-block;
             box-shadow: 0 2px 6px rgba(0,0,0,0.08);
             transition: all 0.25s ease;
           "
           onmouseover="this.style.backgroundColor='#ff8b33'; this.style.boxShadow='0 4px 10px rgba(0,0,0,0.15)';"
           onmouseout="this.style.backgroundColor='#fc7306'; this.style.boxShadow='0 2px 6px rgba(0,0,0,0.08)';"
           onmousedown="this.style.backgroundColor='#e45e00';"
           onmouseup="this.style.backgroundColor='#ff8b33';">
          All Essays on SG
        </a>
      `;
    }
    // News articles: NO archive button (default current affairs view)

    // Assemble the row: archive button (left) + arrow container (right)
    if (articleType !== 'news') {
      topControlsRow.appendChild(archiveBtnLeft);
    }
    topControlsRow.appendChild(arrowContainer);

    tile.appendChild(topControlsRow);

    container.appendChild(tile);
  });
} // End of renderArticles() function

// DUPLICATE CODE REMOVED - Lines 402-574 were orphaned code causing "article is not defined" error

// -----------------------------
// Clean URL: convert title to slug
// -----------------------------
function slugifyTitle(title) {
  return title.toLowerCase()
              .replace(/[^a-z0-9]+/g, "-")  // replace non-alphanumerics with "-"
              .replace(/^-+|-+$/g, "");     // trim leading/trailing "-"
}

// -----------------------------
// Convert human-readable date to ISO format (YYYY-MM-DD)
// -----------------------------
function convertDateToISO(dateString) {
  // Converts "18 July 2025" → "2025-07-18"
  const months = {
    'january': '01', 'february': '02', 'march': '03', 'april': '04',
    'may': '05', 'june': '06', 'july': '07', 'august': '08',
    'september': '09', 'october': '10', 'november': '11', 'december': '12'
  };

  const parts = dateString.trim().split(' ');
  const day = parts[0].padStart(2, '0');
  const month = months[parts[1].toLowerCase()];
  const year = parts[2];

  return `${year}-${month}-${day}`;
}

// -----------------------------
// Update URL when a tile/article is opened
// -----------------------------
function updateURLForArticle(title, publishDate, articleType = 'news') {
  const slug = slugifyTitle(title);
  // Convert "18 July 2025" to "2025-07-18" for clean, SEO-friendly URLs
  const isoDate = convertDateToISO(publishDate);

  // SEO-optimized URL structure based on article type (v2.0)
  let newPath;
  switch(articleType) {
    case 'editorial':
      newPath = `/upsc-editorials/${isoDate}/${slug}`;  // ✅ Updated: cleaner URL
      break;
    case 'ethics':
      newPath = `/upsc-ethics/${slug}`;  // ✅ Updated: NO DATE (timeless content)
      break;
    case 'essay':
      newPath = `/upsc-essays/${slug}`;  // ✅ Updated: NO DATE (timeless content) + plural
      break;
    case 'news':
    default:
      newPath = `/upsc-current-affairs/${isoDate}/${slug}`;
      break;
  }

  history.replaceState(null, "", newPath);
}

// -----------------------------
// Get publish Date and slug from URL
// -----------------------------
function getArticleDataFromURL() {
  // Example pathnames (v2.0):
  // "/upsc-current-affairs/2025-08-25" → all articles for date
  // "/upsc-current-affairs/2025-08-25/article-slug" → specific news article
  // "/upsc-editorials/2025-08-25/article-slug" → specific editorial (NEW!)
  // "/upsc-editorials/" → all editorials archive
  // "/upsc-ethics/article-slug" → specific ethics (NO DATE - NEW!)
  // "/upsc-ethics/" → all ethics archive
  // "/upsc-essays/article-slug" → specific essay (NO DATE - NEW!)
  // "/upsc-essays/" → all essays archive

  const pathParts = window.location.pathname.split("/").filter(Boolean);

  // Handle Current Affairs (News only)
  if (pathParts[0] === 'upsc-current-affairs') {
    if (pathParts.length === 2) {
      return { articleType: 'news', publishDate: pathParts[1], slug: null };
    } else if (pathParts.length >= 3) {
      return { articleType: 'news', publishDate: pathParts[1], slug: pathParts[2] };
    }
  }

  // Handle Editorials (separate category now - v2.0)
  if (pathParts[0] === 'upsc-editorials') {
    if (pathParts.length === 1) {
      // Archive page: /upsc-editorials/
      return { articleType: 'editorial', publishDate: null, slug: null, isArchive: true };
    } else if (pathParts.length === 2) {
      // Date page: /upsc-editorials/2025-01-18
      return { articleType: 'editorial', publishDate: pathParts[1], slug: null };
    } else if (pathParts.length >= 3) {
      // Specific article: /upsc-editorials/2025-01-18/article-slug
      return { articleType: 'editorial', publishDate: pathParts[1], slug: pathParts[2] };
    }
  }

  // Handle Ethics (NO DATE - v2.0)
  if (pathParts[0] === 'upsc-ethics') {
    if (pathParts.length === 1) {
      // Archive page: /upsc-ethics/
      return { articleType: 'ethics', publishDate: null, slug: null, isArchive: true };
    } else if (pathParts.length >= 2) {
      // Specific article: /upsc-ethics/article-slug (NO DATE!)
      return { articleType: 'ethics', publishDate: null, slug: pathParts[1] };
    }
  }

  // Handle Essays (NO DATE - v2.0)
  if (pathParts[0] === 'upsc-essays') {
    if (pathParts.length === 1) {
      // Archive page: /upsc-essays/
      return { articleType: 'essay', publishDate: null, slug: null, isArchive: true };
    } else if (pathParts.length >= 2) {
      // Specific article: /upsc-essays/article-slug (NO DATE!)
      return { articleType: 'essay', publishDate: null, slug: pathParts[1] };
    }
  }

  return null;
}

// -----------------------------
// Usage example
// -----------------------------
const articleData = getArticleDataFromURL();
if (articleData) {
  console.log("Publish Date:", articleData.publishDate);
  console.log("Slug:", articleData.slug);
}


window.onload = function () {
  // ================================
  // DATE-BASED URL HANDLING
  // ================================
  // Check if coming from homepage with date parameter (legacy fallback)
  const urlParams = new URLSearchParams(window.location.search);
  const dateParam = urlParams.get('date'); // e.g., "2025-08-25"

  if (dateParam) {
    // Update URL to SEO-optimized structure (remove query param)
    history.replaceState(null, '', `/upsc-current-affairs/${dateParam}`);
  }

  let selectedRange = null;
  let paletteElement = null;
  let paletteTimeout = null; // ⬅️ Track the auto-hide timeout


  function createHighlightPalette(x, y) {
    // Remove existing palette
    if (paletteElement) paletteElement.remove();
    clearTimeout(paletteTimeout); // ⬅️ Clear any previous timeout


    // Create palette
    const colors = ['#ffff66', '#a2faa3', '#9df2ff', '#ffb3ba'];
    paletteElement = document.createElement('div');
    paletteElement.className = 'highlight-palette';


    // Tick button (needs access in color-btn onclick)
    const tickButton = document.createElement('button');
    tickButton.textContent = '✓✓';
    tickButton.className = 'tick-btn';
    tickButton.style.display = 'none';


    tickButton.onclick = function () {
      paletteElement.remove();
      selectedRange = null;
      clearTimeout(paletteTimeout); // ⬅️ Stop timer if ticked
    };


    // Add color buttons
    colors.forEach(color => {
      const button = document.createElement('button');
      button.className = 'color-btn';
      button.style.backgroundColor = color;


      button.onclick = function () {
        if (!selectedRange) return;


        const span = document.createElement('span');
        span.className = 'custom-highlight';
        span.style.backgroundColor = color;
        span.textContent = selectedRange.toString();


        selectedRange.deleteContents();
        selectedRange.insertNode(span);


        tickButton.style.display = 'inline-block';
        clearTimeout(paletteTimeout); // ⬅️ Cancel auto-hide on color select
      };


      paletteElement.appendChild(button);
    });


    paletteElement.appendChild(tickButton);
    document.body.appendChild(paletteElement);


   {
  const isMobile = window.innerWidth <= 767; // You can tweak this threshold if needed
  const offsetY = isMobile ? 110 : 75;       // 110 for mobile, 75 for larger screens


  paletteElement.style.position = 'absolute';
  paletteElement.style.top = `${y + offsetY}px`; // Adaptive offset below the selection
  paletteElement.style.left = `${x}px`;
  paletteElement.style.transform = 'translateX(0)';
}


    // ⏲️ Auto-hide after 5 seconds if no interaction
    paletteTimeout = setTimeout(() => {
      if (paletteElement) {
        paletteElement.remove();
        paletteElement = null;
        selectedRange = null;
        window.getSelection()?.removeAllRanges(); // Clear selection
      }
    }, 5000);
  }


  document.addEventListener('selectionchange', function () {
    const selection = window.getSelection();
    if (!selection.rangeCount || selection.isCollapsed) return;


    const range = selection.getRangeAt(0);
    const rect = range.getBoundingClientRect();


    selectedRange = range.cloneRange();
    createHighlightPalette(rect.left + window.scrollX, rect.top + window.scrollY - 50);
  });
// --- Step 1: Render hardcoded data immediately ---
  // renderArticles(sampleArticles);

  // --- Step 2: Try to fetch from backend API ---
  fetch('/api/articles')
    .then(res => res.json())
    .then(data => {
      if (Array.isArray(data) && data.length > 0) {
        renderArticles(data);
      } else {
        console.warn("API returned empty list, keeping fallback data.");
      }
    })
    .catch(err => {
      console.error("API fetch failed, using fallback data:", err);
    });


  // Optional article render logic
  renderArticles();

  // ⬆ This delay ensures that buttons.js fully loads and that articles exist in the DOM before event listeners attach.
  // Needed because buttons.js defines reinitializeButtons() but articles are rendered only after window.onload.
  // WAIT for buttons.js to load, then safely initialize
  setTimeout(() => {
    if (typeof window.reinitializeButtons === 'function') {
      console.log('🔧 Initializing buttons...');
      window.reinitializeButtons();
      console.log('✅ Buttons initialized');
    } else {
      console.error('❌ window.reinitializeButtons not found!');
    }
  }, 150);


  const articleData = getArticleDataFromURL();
  if (articleData && articleData.slug) {
    setTimeout(() => {
      const tiles = document.querySelectorAll(".article-tile");
      tiles.forEach(tile => {
        const title = tile.querySelector(".article-title")?.textContent || "";
        if (slugifyTitle(title) === articleData.slug) {
          tile.querySelector(".main-arrow-btn")?.click();
        }
      });
    }, 100);
  }
};
function openFloatingViewer(src) {
  const viewer = document.getElementById("floating-image-viewer");
  const image = document.getElementById("floating-image");



  image.src = src;
  image.classList.remove("zoomed"); // Reset zoom
  viewer.classList.remove("hidden");
}


// Close button (×) functionality
document.getElementById("close-floating-image")?.addEventListener("click", () => {
  const viewer = document.getElementById("floating-image-viewer");
  viewer.classList.add("hidden");
});
document.addEventListener("DOMContentLoaded", () => {
  const closeBtn = document.getElementById("close-floating-image");
  const viewer = document.getElementById("floating-image-viewer");


  if (closeBtn && viewer) {
    closeBtn.addEventListener("click", () => {
      viewer.classList.add("hidden");
    });
  }
});
// ========== Block Ctrl+C, Ctrl+S, Ctrl+P ==========


document.addEventListener('DOMContentLoaded', () => {
  // Block Ctrl+C / Ctrl+S / Ctrl+P
  document.addEventListener('keydown', function (e) {
    if ((e.ctrlKey || e.metaKey) && ['c', 's', 'p'].includes(e.key.toLowerCase())) {
      e.preventDefault();
      e.stopPropagation();
    }
  }, true);


  // Block right-click context menu everywhere
  document.addEventListener('contextmenu', function (e) {
    e.preventDefault();
  });


  // Block long-press on mobile (by canceling touchstart + disabling callout)
  document.body.addEventListener('touchstart', function (e) {
    if (e.target.tagName === 'IMG' || e.target.closest('.no-long-press')) {
      e.preventDefault();
    }
  }, { passive: false });


  // Optional: Disable selection and dragging of images
  document.querySelectorAll('img, .no-save').forEach(img => {
    img.setAttribute('draggable', 'false');
    img.style.userSelect = 'none';
    img.style.pointerEvents = 'none';
  });
});


// ✅ Zoom toggle on image click
document.getElementById("floating-image")?.addEventListener("click", function () {
  this.classList.toggle("zoomed");
});
document.getElementById("floating-image").addEventListener("contextmenu", function (e) {
  e.preventDefault();
  alert("⚠️ This image is meant to aid your absorption of the issue. Downloading may not help. Nevertheless Samyag Gyan will be available each fortnight with all relevant Mindmaps.");
});

// ========== Security Features JS ==========

// 1. ❌ Block Ctrl+C, Ctrl+S, Ctrl+P (copy, save, print)
document.addEventListener('keydown', function (e) {
  if ((e.ctrlKey || e.metaKey) && ['c', 's', 'p'].includes(e.key.toLowerCase())) {
    e.preventDefault();
  }
});


// 2. ❌ Disable right-click on desktop
document.addEventListener('contextmenu', function (e) {
  e.preventDefault();
});


// 3. ❌ Block long-press menu on mobile (which usually opens text copy options)
document.addEventListener('touchstart', function (e) {
  if (e.targetTouches.length > 1) return; // allow pinch-zoom
  this._longPressTimer = setTimeout(function () {
    e.preventDefault(); // block long-press context menu
  }, 500);
}, { passive: false });


document.addEventListener('touchend', function () {
  clearTimeout(this._longPressTimer);
});
//Homepage tile tooltip (Edits ReQuired)
function showTileTooltip() {
  const tooltip = document.getElementById('tile-tooltip');
  const overlay = document.getElementById('tile-overlay');

  if (!tooltip || !overlay) return;

  tooltip.style.display = 'block';
  overlay.style.display = 'block';

  setTimeout(() => {
    tooltip.style.display = 'none';
    overlay.style.display = 'none';
  }, 2000); // Show for 2 seconds
}

window.addEventListener('load', showTileTooltip);

// ==================== Save Highlight ====================
function saveHighlightToBackend(userId, articleId, language, questionType, questionId, answerId, highlightedText) {
  fetch('/api/save-highlight', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      user_id: userId,
      article_id: articleId,
      language: language,             // 'en' or 'hi' depending on user
      question_type: questionType,    // 'mains' or 'prelims'
      question_id: questionId,        // Exact backend question ID
      answer_id: answerId || null,    // Exact backend answer ID if applicable
      highlighted_text: highlightedText
    })
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      console.log("✅ Highlight saved:", data.highlight_id);
      // Optionally: show visual tick animation
    } else {
      console.error("❌ Save failed:", data.message);
      alert("Failed to save highlight.");
    }
  })
  .catch(err => {
    console.error("❌ Error:", err);
    alert("Error saving highlight.");
  });
}

// ==================== Handle Text Selection ====================
document.addEventListener('mouseup', function (event) {
  const selection = window.getSelection();
  const selectedText = selection.toString().trim();
  if (!selectedText) return;

  // Determine the allowed parent (paragraph inside question/answer)
  const allowedParent = selection.anchorNode?.parentElement?.closest(
    '.highlight-zone p, .prelims-answer p'
  );
  if (!allowedParent) return;

  // Check word boundaries
  const range = selection.getRangeAt(0);
  const preChar = range.startOffset > 0 ? range.startContainer.textContent[range.startOffset - 1] : ' ';
  const postChar = range.endOffset < range.endContainer.textContent.length
    ? range.endContainer.textContent[range.endOffset]
    : ' ';
  if (!/\s/.test(preChar) || !/\s/.test(postChar)) return;

  // Get article_id and language from hidden meta div
  const articleMetaDiv = document.getElementById('article-meta');
  const articleId = articleMetaDiv?.getAttribute('data-article-id');
  const language = articleMetaDiv?.getAttribute('data-language') || 'en';

  // Determine question type and IDs
  let questionType, questionId = null, answerId = null;

  // Look specifically for backend-driven attributes
  const mainsQuestionEl = allowedParent.closest('.highlight-zone')?.querySelector('[data-main_question_id]');
  const prelimsQuestionEl = allowedParent.closest('.prelims-subtile')?.querySelector('[data-prelims_question_id]');

  if (mainsQuestionEl) {
    questionType = 'mains';
    questionId = mainsQuestionEl.getAttribute('data-main_question_id');     // backend main_question_id
    answerId = allowedParent.getAttribute('data-main_answer_id') || null;   // backend main_answer_id
  } else if (prelimsQuestionEl) {
    questionType = 'prelims';
    questionId = prelimsQuestionEl.getAttribute('data-prelims_question_id'); // backend prelims_question_id
    answerId = allowedParent.getAttribute('data-prelims_answer_id') || null;  // backend prelims_answer_id
  }

  if (!questionId) return; // Safety: must have a valid question ID

  // Optional debug
  console.log({
    articleId,
    language,
    questionType,
    questionId,
    answerId,
    highlightedText: selectedText
  });

  // Send highlight to backend
  saveHighlightToBackend(
    CURRENT_USER_ID,   // Global variable (Telegram user ID)
    articleId,
    language,
    questionType,
    questionId,
    answerId,
    selectedText
  );
});