const articles = [
  {
    "title": "Digital Public Infrastructure in India",
    "hashtags": "#Governance #DigitalIndia #CurrentAffairs", // 
    "source_ribbon": "the-hindu", // ➡️ Renamed property
    "secondary_ribbon": "Essay + GS2", // ➡️ Renamed property
    "publish_date": "18 July 2025", // ➡️ Renamed property
    "prelude_title": "Why should I read it?", // ➡️ Split into two properties
    "prelude_body": "It ties digital India with delivery on the ground. You’ll see governance come alive in numbers. Also, it’s a gem for GS2 introductions.", // ➡️ Split into two properties
    "content": [
      {
        "main_question_id": 101, // Example ID for the database
        "main_answer_id": 201, // Example ID for the database
        "article_id": 1,
        "language": "en",
        "question": "✦ What is Digital Public Infrastructure (DPI)?",
        "answer": "DPI refers to foundational systems like Aadhaar, UPI, DigiLocker and more that create a base for scalable public digital services. These systems enable identity, payments, and document verification at scale. Together, they make service delivery faster, cheaper, and more inclusive. This public-facing technology stack is built on open standards, promoting a shared ecosystem for innovation. It operates on a consent-based framework, giving citizens control over their data while ensuring security and privacy. The integrated nature of these platforms is what allows for a seamless and interconnected digital economy."
      },
      {
        "main_question_id": 102,
        "main_answer_id": 202,
        "article_id": 1,
        "language": "en",
        "question": "✦ How is DPI transforming governance?",
        "answer": "Government schemes use Aadhaar-based DBT to directly transfer benefits, avoiding middlemen and leakages. DigiLocker digitizes records like driving licenses and academic certificates. UPI allows anyone with a phone and bank account to send or receive payments instantly, without transaction fees. This direct transfer model has revolutionized welfare distribution, ensuring that subsidies reach the intended beneficiaries efficiently. The digitization of documents reduces bureaucratic hurdles and makes government services more accessible to a wider population. The widespread adoption of UPI has also bolstered financial inclusion, bringing millions into the formal banking system for the first time."
      },
      {
        "main_question_id": 103,
        "main_answer_id": 203,
        "article_id": 1,
        "language": "en",
        "question": "✦ Why is India's model globally praised?",
        "answer": "India's DPI stack is open, low-cost, scalable, and sovereign. It's being adapted by countries in Africa, Latin America, and Southeast Asia. The absence of corporate dependencies (like GAFA) makes it attractive for nations seeking self-reliance in digital governance. This approach provides a viable alternative to proprietary, corporate-driven models, which often come with high costs and data control issues. The open-source nature of the technology encourages global collaboration and co-creation. Ultimately, India's model demonstrates that a public-good approach can be a powerful engine for both economic growth and social equity."
      }
    ],
    "endRibbons": [
      {
        "label": " Mindmap (English)",
        "color": "#FF9800",
        "type": "mindmap",
        "src": "1.jpg"
      },
      {
        "label": " Prelims Pointers",
        "color": "#673AB7",
        "type": "prelims",
        "content": [
          {
            "prelims_question_id": 301, // Example ID for the database
            "prelims_answer_id": 401, // Example ID for the database
            "article_id": 1,
            "language": "en",
            "q": "What is DPI?",
            "a": "DPI is the foundational digital infrastructure for public services like Aadhaar and UPI, providing a secure and interoperable platform for identity, payments, and data exchange. It enables efficient and inclusive service delivery across various sectors, creating a robust digital ecosystem that benefits all citizens."
          },
          {
            "prelims_question_id": 302,
            "prelims_answer_id": 402,
            "article_id": 1,
            "language": "en",
            "q": "Why important?",
            "a": "DPI is crucial for ensuring financial and social inclusion, as it provides a low-cost, scalable, and transparent way to deliver benefits and services directly to citizens. By reducing leakages and streamlining processes, it enhances governance, fosters economic growth, and helps India achieve its Sustainable Development Goals."
          }
        ]
      },
      {
        "label": " माइंडमैप (Hindi)",
        "color": "#FF9800",
        "type": "mindmap",
        "src": "mindmap_hin1.jpg"
      }
    ]
  },
  {
    "title": "India’s Renewable Energy Transition",
    "hashtags": "#Environment #Energy #GS3",
    "source_ribbon": "indian-express",
    "secondary_ribbon": "GS3 Case Study + SDG Linkage",
    "publish_date": "18 July 2025",
    "prelude_title": "Why should I read it?",
    "prelude_body": "This ties India's green push to global promises. Makes SDGs, solar parks and hydrogen efforts easy to cite. Every sentence can become a pointer in notes.",
    "content": [
      {
        "main_question_id": 104,
        "main_answer_id": 204,
        "article_id": 2,
        "language": "en",
        "question": "✦ Why renewable energy for India?",
        "answer": "India has rising energy needs, a large rural population, and global climate commitments. Renewable sources like solar and wind offer sustainable, decentralized alternatives to coal-based energy. Clean energy reduces pollution and dependency on imported oil. Shifting to renewables also enhances the country's energy security, protecting it from volatile international fuel markets. The transition supports sustainable development goals and creates new job opportunities in the green sector. Moreover, decentralized renewable energy solutions are ideal for electrifying remote rural areas that are difficult to connect to the traditional grid."
      },
      {
        "main_question_id": 105,
        "main_answer_id": 205,
        "article_id": 2,
        "language": "en",
        "question": "✦ What major steps has India taken?",
        "answer": "The National Solar Mission has scaled solar parks across states. New incentives encourage green hydrogen and battery storage. India aims to install 500 GW of non-fossil capacity by 2030, supporting SDG 7 (Affordable & Clean Energy). The government has implemented a Production Linked Incentive (PLI) scheme to boost domestic manufacturing of solar PV modules and advanced chemistry cells. Programs like PM-KUSUM help farmers adopt solar pumps, which reduces reliance on fossil fuels for irrigation. The country is also focusing on developing a robust green energy corridor to transmit renewable power from generation sites to consumption centers efficiently."
      },
      {
        "main_question_id": 106,
        "main_answer_id": 206,
        "article_id": 2,
        "language": "en",
        "question": "✦ What challenges remain?",
        "answer": "Energy storage tech is still evolving. Land acquisition delays big projects. Transmission infrastructure needs investment. The intermittent nature of solar and wind power requires sophisticated grid management and large-scale battery storage solutions. Social challenges include the potential for job displacement in the traditional coal industry and the need for reskilling the workforce. Securing financing for large-scale renewable projects, especially in the early stages, also presents a significant hurdle for developers and investors."
      }
    ],
    "endRibbons": [
      {
        "label": " Mindmap (English)",
        "color": "#FF9800",
        "type": "mindmap",
        "src": "mindmap_eng2.jpg"
      },
      {
        "label": " Prelims Pointers",
        "color": "#673AB7",
        "type": "prelims",
        "content": [
          {
            "prelims_question_id": 303,
            "prelims_answer_id": 403,
            "article_id": 2,
            "language": "en",
            "q": "Target by 2030?",
            "a": "India has set a highly ambitious target of achieving 500 GW of non-fossil fuel electricity generation capacity by 2030, which is a key component of its commitment to combating climate change. This goal is crucial for meeting the country's growing energy needs in a sustainable manner and reducing its reliance on fossil fuels."
          },
          {
            "prelims_question_id": 304,
            "prelims_answer_id": 404,
            "article_id": 2,
            "language": "en",
            "q": "New initiatives?",
            "a": "Recent initiatives include a strong policy push for green hydrogen, which is seen as a key fuel for the future, and new incentives for battery storage projects to address the intermittency of renewable sources. The government is also promoting the establishment of large-scale solar parks to achieve economies of scale and accelerate the deployment of solar energy across the country."
          }
        ]
      },
      {
        "label": " माइंडमैप (हिन्दी)",
        "color": "#FF9800",
        "type": "mindmap",
        "src": "mindmap_hin2.jpg"
      }
    ]
  }
];

const sourceMap = { "the-hindu": "The Hindu", "indian-express": "Indian Express", "both": "Both (IE + TH)", "pib-other": "PIB / Other" };

const source_ribbon = { "the-hindu": "#009688", "indian-express": "#8BC34A", "both": "#2196F3", "pib-other": "#D32F2F" };

function renderArticles() { 
  const container = document.getElementById('articles-container'); 
  container.innerHTML = '';

  articles.forEach((article) => { 
    const tile = document.createElement('div'); 
    tile.classList.add('article-tile'); 
    tile.dataset.expanded = 'false';

    const leftRibbon = document.createElement('div');
    leftRibbon.className = 'source-ribbon';
    leftRibbon.textContent = sourceMap[article.source_ribbon] || "Source"; //  Correct property name
    leftRibbon.style.backgroundColor = source_ribbon[article.source_ribbon] || "#666"; //  Correct property name

    const usabilityRibbon = document.createElement('div');
    usabilityRibbon.className = 'usability-ribbon';
    usabilityRibbon.textContent = article.secondary_ribbon || ""; // Correct property name

    const title = document.createElement('div');
    title.className = 'article-title';
    title.textContent = article.title;

    const tags = document.createElement('div');
    tags.className = 'tags';
    tags.textContent = article.hashtags; //  Correct property name

    const dateBlock = document.createElement('div');
    dateBlock.className = 'article-date';
    dateBlock.textContent = article.publish_date || ""; //  Correct property name
    dateBlock.style.display = 'none';

    const preludeWrap = document.createElement('div');
    preludeWrap.className = 'prelude-section';
    preludeWrap.innerHTML = `
      <span class="prelude-title">${article.prelude_title || 'Why should I read it?'}</span>
      <span class="prelude-body">${article.prelude_body || ''}</span>
    `; // ✅ Correct property names
    preludeWrap.style.display = 'none';

    const contentArea = document.createElement('div');
    contentArea.className = 'content-area highlight-zone';
    contentArea.style.display = 'none';

    // ==================== MAIN CONTENT Q&A ====================
    article.content.forEach((qna) => {
      const q = document.createElement('span');
      q.className = 'question';
      q.dataset.main_question_id = qna.main_question_id;
      q.dataset.article_id = qna.article_id;
      q.dataset.language = qna.language || 'en';
      q.textContent = qna.question;

      const a = document.createElement('p');
      a.className = 'answer';
      a.dataset.main_answer_id = qna.main_answer_id;
      a.dataset.main_question_id = qna.main_question_id;
      a.dataset.article_id = qna.article_id;
      a.dataset.language = qna.language || 'en';
      a.textContent = qna.answer;

      contentArea.appendChild(q);
      contentArea.appendChild(a);
    });

    const endRibbonZone = document.createElement('div');
    endRibbonZone.className = 'end-content-ribbons';
    endRibbonZone.style.display = 'none';

    const subContentBox = document.createElement('div');
    subContentBox.className = 'sub-tile';
    subContentBox.style.display = 'none';

    article.endRibbons.forEach((r) => {
      const ribbon = document.createElement('div');
      ribbon.className = 'end-content-ribbon-item';
      ribbon.textContent = r.label;
      ribbon.style.backgroundColor = r.color;

      ribbon.addEventListener('click', () => {
        subContentBox.innerHTML = '';
        if (r.type === 'mindmap') {
          openFloatingViewer(r.src);
        } else if (r.type === 'prelims') {
          const wrapper = document.createElement('div');
          wrapper.className = 'prelims-content-wrapper';
          r.content.forEach((qna) => {
            const q = document.createElement('div');
            q.className = 'prelims-question';
            q.dataset.prelims_question_id = qna.prelims_question_id;
            q.dataset.article_id = qna.article_id;
            q.dataset.language = qna.language || 'en';
            q.textContent = qna.q;

            const a = document.createElement('div');
            a.className = 'prelims-answer';
            a.dataset.prelims_answer_id = qna.prelims_answer_id;
            a.dataset.prelims_question_id = qna.prelims_question_id;
            a.dataset.article_id = qna.article_id;
            a.dataset.language = qna.language || 'en';
            a.textContent = qna.a;

            wrapper.appendChild(q);
            wrapper.appendChild(a);
          });
          subContentBox.appendChild(wrapper);
          subContentBox.style.display = 'block';
        }
      });
      endRibbonZone.appendChild(ribbon);
    });

    const arrowContainer = document.createElement('div');
    const arrowBtn = document.createElement('button');
    arrowBtn.className = 'main-arrow-btn';
    arrowBtn.innerHTML = '<div class="css-arrow"></div>';

    arrowBtn.addEventListener('click', () => {
      const isExpanded = tile.classList.contains('expanded');
      document.querySelectorAll('.article-tile').forEach((t) => {
        t.classList.remove('expanded');
        t.dataset.expanded = 'false';
        t.querySelector('.content-area').style.display = 'none';
        t.querySelector('.sub-tile').style.display = 'none';
        t.querySelector('.end-content-ribbons').style.display = 'none';
        t.querySelector('.prelude-section').style.display = 'none';
        t.querySelector('.article-date').style.display = 'none';
        t.querySelector('.main-arrow-btn').classList.remove('rotated');
        if (t.querySelector('.read-button-wrapper')) {
          t.querySelector('.read-button-wrapper').style.display = 'none';
        }
      });

      if (!isExpanded) {
        tile.classList.add('expanded');
        tile.dataset.expanded = 'true';
        contentArea.style.display = 'block';
        endRibbonZone.style.display = 'flex';
        preludeWrap.style.display = 'block';
        dateBlock.style.display = 'block';
        arrowBtn.classList.add('rotated');
        updateURLForArticle(article.title, article.publish_date); // ✅ Correct property name
        readButtonWrapper.style.display = 'flex';
        showTileTooltip();
      }
    });

    arrowContainer.className = 'arrow-container';
    arrowContainer.appendChild(arrowBtn);

    tile.appendChild(leftRibbon);
    tile.appendChild(usabilityRibbon);
    tile.appendChild(title);
    tile.appendChild(tags);
    tile.appendChild(dateBlock);
    tile.appendChild(preludeWrap);
    tile.appendChild(contentArea);
    tile.appendChild(endRibbonZone);
    tile.appendChild(subContentBox);

    const readButtonWrapper = document.createElement('div');
    readButtonWrapper.className = 'read-button-wrapper';
    readButtonWrapper.innerHTML = ``;
    readButtonWrapper.style.display = 'none';
    tile.appendChild(readButtonWrapper);

    const separator = document.createElement('hr');
    separator.className = 'tile-separator';
    tile.appendChild(separator);
    tile.appendChild(arrowContainer);

    container.appendChild(tile);
  });



  const endRibbonZone = document.createElement('div');
    endRibbonZone.className = 'end-content-ribbons';
  endRibbonZone.style.display = 'none';

  const subContentBox = document.createElement('div');
  subContentBox.className = 'sub-tile';
  subContentBox.style.display = 'none';


article.endRibbons.forEach((r, ribbonIndex) => {
  const ribbon = document.createElement('div');
  ribbon.className = 'end-content-ribbon-item';
  ribbon.textContent = r.label;
  ribbon.style.backgroundColor = r.color;

  ribbon.addEventListener('click', () => {
    subContentBox.innerHTML = '';

    if (r.type === 'mindmap') {
      openFloatingViewer(r.src);
    } else if (r.type === 'prelims') {
      const wrapper = document.createElement('div');
      wrapper.className = 'prelims-content-wrapper';

      // ==================== PRELIMS CONTENT Q&A ====================
      r.content.forEach((qna) => {
      const q = document.createElement('div');
    q.className = 'prelims-question';

    q.dataset.prelims_question_id = qna.prelims_question_id; // prelims_questions table
    q.dataset.article_id          = qna.article_id;          // articles table
    q.dataset.language            = qna.language || 'en';

    q.textContent = qna.q;

    const a = document.createElement('div');
    a.className = 'prelims-answer';

    a.dataset.prelims_answer_id   = qna.prelims_answer_id;  // prelims_answers table
    a.dataset.prelims_question_id = qna.prelims_question_id;
    a.dataset.article_id          = qna.article_id;
    a.dataset.language            = qna.language || 'en';

    a.textContent = qna.a;

    wrapper.appendChild(q);
    wrapper.appendChild(a);
});

      subContentBox.appendChild(wrapper);
      subContentBox.style.display = 'block';
    }
  });

  endRibbonZone.appendChild(ribbon);
});


const arrowContainer = document.createElement('div');
const arrowBtn = document.createElement('button');
arrowBtn.className = 'main-arrow-btn';
arrowBtn.innerHTML = '<div class="css-arrow"></div>';


arrowBtn.addEventListener('click', () => {
  const isExpanded = tile.classList.contains('expanded');


  document.querySelectorAll('.article-tile').forEach((t) => {
    t.classList.remove('expanded');
    t.dataset.expanded = 'false';
    t.querySelector('.content-area').style.display = 'none';
    t.querySelector('.sub-tile').style.display = 'none';
    t.querySelector('.end-content-ribbons').style.display = 'none';
    t.querySelector('.prelude-section').style.display = 'none';
    t.querySelector('.article-date').style.display = 'none';
    t.querySelector('.main-arrow-btn').classList.remove('rotated');
    if (t.querySelector('.read-button-wrapper')) {
  t.querySelector('.read-button-wrapper').style.display = 'none';
}
  });


 if (!isExpanded) {
  tile.classList.add('expanded');
  tile.dataset.expanded = 'true';
  contentArea.style.display = 'block';
  endRibbonZone.style.display = 'flex';
  preludeWrap.style.display = 'block';
  dateBlock.style.display = 'block';
  arrowBtn.classList.add('rotated');
  updateURLForArticle(article.title);
  readButtonWrapper.style.display = 'flex';

  showTileTooltip(); // ✅ Add this line
}
});

arrowContainer.className = 'arrow-container';
arrowContainer.appendChild(arrowBtn);

tile.appendChild(leftRibbon);
tile.appendChild(usabilityRibbon);
tile.appendChild(title);
tile.appendChild(tags);
tile.appendChild(dateBlock);
tile.appendChild(preludeWrap);
tile.appendChild(contentArea);
tile.appendChild(endRibbonZone);
tile.appendChild(subContentBox);
// Insert Read button codes  Part 1
// --- INSERT THIS START ---
const readButtonWrapper = document.createElement('div');
readButtonWrapper.className = 'read-button-wrapper';
readButtonWrapper.innerHTML = `
   
`;
readButtonWrapper.style.display = 'none'; // Intitially hidden
tile.appendChild(readButtonWrapper);

const separator = document.createElement('hr');  // Separator line just above the arrow
separator.className = 'tile-separator';
tile.appendChild(separator);
tile.appendChild(arrowContainer);

tile.appendChild(arrowContainer); // arrowContainer defined Pehle hi

container.appendChild(tile); // Container and tile are defined earlier

const markBtn = readButtonWrapper.querySelector('.read-button');
const markText = readButtonWrapper.querySelector('.read-text');
const tick = readButtonWrapper.querySelector('.ticks');
const bookIcon = readButtonWrapper.querySelector('.read-icon'); // The SVG element itself

let isRead = false; // Initial state

// PARTS (for the Button)

}

// -----------------------------
// Clean URL: convert title to slug
// -----------------------------
function slugifyTitle(title) {
  return title.toLowerCase()
              .replace(/[^a-z0-9]+/g, "-")  // replace non-alphanumerics with "-"
              .replace(/^-+|-+$/g, "");     // trim leading/trailing "-"
}

// -----------------------------
// Update URL when a tile/article is opened
// -----------------------------
function updateURLForArticle(title, publishDate) {
  const slug = slugifyTitle(title);
  // publishDate should be in YYYY-MM-DD format (Sorted for reader and SEO useful)
  const newPath = `/${publishDate}/${slug}`;
  history.replaceState(null, "", newPath);
}

// -----------------------------
// Get publishDate and slug from URL
// -----------------------------
function getArticleDataFromURL() {
  // Example pathname: "/2025-08-13/my-article-title"
  const pathParts = window.location.pathname.split("/").filter(Boolean);
  if (pathParts.length >= 2) {
    const publishDate = pathParts[0]; // "YYYY-MM-DD"
    const slug = pathParts[1];        // "article-title"
    return { publishDate, slug };
  }
  return null;
}

// -----------------------------
// Usage example
// -----------------------------
const articleData = getArticleDataFromURL();
if (articleData) {
  console.log("Publish Date:", articleData.publishDate);
  console.log("Slug:", articleData.slug);
}


window.onload = function () {
  let selectedRange = null;
  let paletteElement = null;
  let paletteTimeout = null; // ⬅️ Track the auto-hide timeout


  function createHighlightPalette(x, y) {
    // Remove existing palette
    if (paletteElement) paletteElement.remove();
    clearTimeout(paletteTimeout); // ⬅️ Clear any previous timeout


    // Create palette
    const colors = ['#ffff66', '#a2faa3', '#9df2ff', '#ffb3ba'];
    paletteElement = document.createElement('div');
    paletteElement.className = 'highlight-palette';


    // Tick button (needs access in color-btn onclick)
    const tickButton = document.createElement('button');
    tickButton.textContent = '✓';
    tickButton.className = 'tick-btn';
    tickButton.style.display = 'none';


    tickButton.onclick = function () {
      paletteElement.remove();
      selectedRange = null;
      clearTimeout(paletteTimeout); // ⬅️ Stop timer if ticked
    };


    // Add color buttons
    colors.forEach(color => {
      const button = document.createElement('button');
      button.className = 'color-btn';
      button.style.backgroundColor = color;


      button.onclick = function () {
        if (!selectedRange) return;


        const span = document.createElement('span');
        span.className = 'custom-highlight';
        span.style.backgroundColor = color;
        span.textContent = selectedRange.toString();


        selectedRange.deleteContents();
        selectedRange.insertNode(span);


        tickButton.style.display = 'inline-block';
        clearTimeout(paletteTimeout); // ⬅️ Cancel auto-hide on color select
      };


      paletteElement.appendChild(button);
    });


    paletteElement.appendChild(tickButton);
    document.body.appendChild(paletteElement);


   {
  const isMobile = window.innerWidth <= 767; // You can tweak this threshold if needed
  const offsetY = isMobile ? 110 : 75;       // 110 for mobile, 75 for larger screens


  paletteElement.style.position = 'absolute';
  paletteElement.style.top = `${y + offsetY}px`; // Adaptive offset below the selection
  paletteElement.style.left = `${x}px`;
  paletteElement.style.transform = 'translateX(0)';
}


    // ⏲️ Auto-hide after 5 seconds if no interaction
    paletteTimeout = setTimeout(() => {
      if (paletteElement) {
        paletteElement.remove();
        paletteElement = null;
        selectedRange = null;
        window.getSelection()?.removeAllRanges(); // Clear selection
      }
    }, 5000);
  }


  document.addEventListener('selectionchange', function () {
    const selection = window.getSelection();
    if (!selection.rangeCount || selection.isCollapsed) return;


    const range = selection.getRangeAt(0);
    const rect = range.getBoundingClientRect();


    selectedRange = range.cloneRange();
    createHighlightPalette(rect.left + window.scrollX, rect.top + window.scrollY - 50);
  });
// --- Step 1: Render hardcoded data immediately ---
  // renderArticles(sampleArticles);

  // --- Step 2: Try to fetch from backend API ---
  fetch('/api/articles')
    .then(res => res.json())
    .then(data => {
      if (Array.isArray(data) && data.length > 0) {
        renderArticles(data);
      } else {
        console.warn("API returned empty list, keeping fallback data.");
      }
    })
    .catch(err => {
      console.error("API fetch failed, using fallback data:", err);
    });


  // Optional article render logic
  renderArticles();


  const slugFromURL = getArticleSlugFromURL();
  if (slugFromURL) {
    setTimeout(() => {
      const tiles = document.querySelectorAll(".article-tile");
      tiles.forEach(tile => {
        const title = tile.querySelector(".article-title")?.textContent || "";
        if (slugifyTitle(title) === slugFromURL) {
          tile.querySelector(".main-arrow-btn")?.click();
        }
      });
    }, 100);
  }
};
function openFloatingViewer(src) {
  const viewer = document.getElementById("floating-image-viewer");
  const image = document.getElementById("floating-image");



  image.src = src;
  image.classList.remove("zoomed"); // Reset zoom
  viewer.classList.remove("hidden");
}


// Close button (×) functionality
document.getElementById("close-floating-image")?.addEventListener("click", () => {
  const viewer = document.getElementById("floating-image-viewer");
  viewer.classList.add("hidden");
});
document.addEventListener("DOMContentLoaded", () => {
  const closeBtn = document.getElementById("close-floating-image");
  const viewer = document.getElementById("floating-image-viewer");


  if (closeBtn && viewer) {
    closeBtn.addEventListener("click", () => {
      viewer.classList.add("hidden");
    });
  }
});
// ========== Block Ctrl+C, Ctrl+S, Ctrl+P ==========


document.addEventListener('DOMContentLoaded', () => {
  // Block Ctrl+C / Ctrl+S / Ctrl+P
  document.addEventListener('keydown', function (e) {
    if ((e.ctrlKey || e.metaKey) && ['c', 's', 'p'].includes(e.key.toLowerCase())) {
      e.preventDefault();
      e.stopPropagation();
    }
  }, true);


  // Block right-click context menu everywhere
  document.addEventListener('contextmenu', function (e) {
    e.preventDefault();
  });


  // Block long-press on mobile (by canceling touchstart + disabling callout)
  document.body.addEventListener('touchstart', function (e) {
    if (e.target.tagName === 'IMG' || e.target.closest('.no-long-press')) {
      e.preventDefault();
    }
  }, { passive: false });


  // Optional: Disable selection and dragging of images
  document.querySelectorAll('img, .no-save').forEach(img => {
    img.setAttribute('draggable', 'false');
    img.style.userSelect = 'none';
    img.style.pointerEvents = 'none';
  });
});


// ✅ Zoom toggle on image click
document.getElementById("floating-image")?.addEventListener("click", function () {
  this.classList.toggle("zoomed");
});
document.getElementById("floating-image").addEventListener("contextmenu", function (e) {
  e.preventDefault();
  alert("⚠️ This image is meant to aid your absorption of the issue. Downloading may not help. Nevertheless Samyag Gyan will be available each fortnight with all relevant Mindmaps.");
});

// ========== Security Features JS ==========

// 1. ❌ Block Ctrl+C, Ctrl+S, Ctrl+P (copy, save, print)
document.addEventListener('keydown', function (e) {
  if ((e.ctrlKey || e.metaKey) && ['c', 's', 'p'].includes(e.key.toLowerCase())) {
    e.preventDefault();
  }
});


// 2. ❌ Disable right-click on desktop
document.addEventListener('contextmenu', function (e) {
  e.preventDefault();
});


// 3. ❌ Block long-press menu on mobile (which usually opens text copy options)
document.addEventListener('touchstart', function (e) {
  if (e.targetTouches.length > 1) return; // allow pinch-zoom
  this._longPressTimer = setTimeout(function () {
    e.preventDefault(); // block long-press context menu
  }, 500);
}, { passive: false });


document.addEventListener('touchend', function () {
  clearTimeout(this._longPressTimer);
});
//Homepage tile tooltip (Edits ReQuired)
function showTileTooltip() {
  const tooltip = document.getElementById('tile-tooltip');
  const overlay = document.getElementById('tile-overlay');

  if (!tooltip || !overlay) return;

  tooltip.style.display = 'block';
  overlay.style.display = 'block';

  setTimeout(() => {
    tooltip.style.display = 'none';
    overlay.style.display = 'none';
  }, 2000); // Show for 2 seconds
}

window.addEventListener('load', showTileTooltip);

// ==================== Save Highlight ====================
function saveHighlightToBackend(userId, articleId, language, questionType, questionId, answerId, highlightedText) {
  fetch('/api/save-highlight', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      user_id: userId,
      article_id: articleId,
      language: language,             // 'en' or 'hi' depending on user
      question_type: questionType,    // 'mains' or 'prelims'
      question_id: questionId,        // Exact backend question ID
      answer_id: answerId || null,    // Exact backend answer ID if applicable
      highlighted_text: highlightedText
    })
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      console.log("✅ Highlight saved:", data.highlight_id);
      // Optionally: show visual tick animation
    } else {
      console.error("❌ Save failed:", data.message);
      alert("Failed to save highlight.");
    }
  })
  .catch(err => {
    console.error("❌ Error:", err);
    alert("Error saving highlight.");
  });
}

// ==================== Handle Text Selection ====================
document.addEventListener('mouseup', function (event) {
  const selection = window.getSelection();
  const selectedText = selection.toString().trim();
  if (!selectedText) return;

  // Determine the allowed parent (paragraph inside question/answer)
  const allowedParent = selection.anchorNode?.parentElement?.closest(
    '.highlight-zone p, .prelims-answer p'
  );
  if (!allowedParent) return;

  // Check word boundaries
  const range = selection.getRangeAt(0);
  const preChar = range.startOffset > 0 ? range.startContainer.textContent[range.startOffset - 1] : ' ';
  const postChar = range.endOffset < range.endContainer.textContent.length
    ? range.endContainer.textContent[range.endOffset]
    : ' ';
  if (!/\s/.test(preChar) || !/\s/.test(postChar)) return;

  // Get article_id and language from hidden meta div
  const articleMetaDiv = document.getElementById('article-meta');
  const articleId = articleMetaDiv?.getAttribute('data-article-id');
  const language = articleMetaDiv?.getAttribute('data-language') || 'en';

  // Determine question type and IDs
  let questionType, questionId = null, answerId = null;

  // Look specifically for backend-driven attributes
  const mainsQuestionEl = allowedParent.closest('.highlight-zone')?.querySelector('[data-main_question_id]');
  const prelimsQuestionEl = allowedParent.closest('.prelims-subtile')?.querySelector('[data-prelims_question_id]');

  if (mainsQuestionEl) {
    questionType = 'mains';
    questionId = mainsQuestionEl.getAttribute('data-main_question_id');     // backend main_question_id
    answerId = allowedParent.getAttribute('data-main_answer_id') || null;   // backend main_answer_id
  } else if (prelimsQuestionEl) {
    questionType = 'prelims';
    questionId = prelimsQuestionEl.getAttribute('data-prelims_question_id'); // backend prelims_question_id
    answerId = allowedParent.getAttribute('data-prelims_answer_id') || null;  // backend prelims_answer_id
  }

  if (!questionId) return; // Safety: must have a valid question ID

  // Optional debug
  console.log({
    articleId,
    language,
    questionType,
    questionId,
    answerId,
    highlightedText: selectedText
  });

  // Send highlight to backend
  saveHighlightToBackend(
    CURRENT_USER_ID,   // Global variable (Telegram user ID)
    articleId,
    language,
    questionType,
    questionId,
    answerId,
    selectedText
  );
});